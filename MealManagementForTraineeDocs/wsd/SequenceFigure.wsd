@startuml
!pragma charset utf-8
title 初回ログイン処理のシーケンス図

participant User
participant LoginController
participant SecurityConfig
participant AuthenticationManager
participant UserDetailsServiceImpl
participant UserAuthRepository
participant UserAuths
participant PasswordEncoder

User -> LoginController: ログインフォーム送信
activate User
activate LoginController

    LoginController -> SecurityConfig: 認証設定取得
    activate SecurityConfig

    SecurityConfig -> LoginController: 認証設定返却
    deactivate SecurityConfig

        LoginController -> AuthenticationManager: 認証実行(username, password)
        activate AuthenticationManager
        AuthenticationManager -> UserDetailsServiceImpl: ユーザー情報取得(username)

        activate UserDetailsServiceImpl
        UserDetailsServiceImpl -> UserAuthRepository: ユーザー検索(username)
        activate UserAuthRepository
        UserAuthRepository -> UserAuths: データベースから取得
        activate UserAuths
        UserAuths --> UserAuthRepository: ユーザー情報返却
        deactivate UserAuths
        UserAuthRepository --> UserDetailsServiceImpl: UserAuthオブジェクト返却
        deactivate UserAuthRepository
        UserDetailsServiceImpl -> PasswordEncoder: パスワード照合
        activate PasswordEncoder
        PasswordEncoder --> UserDetailsServiceImpl: 照合結果
        deactivate PasswordEncoder
        UserDetailsServiceImpl -> AuthenticationManager: 認証結果返却
        deactivate UserDetailsServiceImpl

    AuthenticationManager -> LoginController: 認証結果返却
    deactivate AuthenticationManager

LoginController -> User: 認証成功/失敗
deactivate LoginController
deactivate User

@enduml
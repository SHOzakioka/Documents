@startuml
!pragma charset utf-8
title 初回ログイン処理のシーケンス図

actor User
participant "ログインフォーム" as LoginForm
participant "Spring Security Filter Chain" as SecurityFilter
participant AuthenticationManager
participant UserDetailsServiceImpl
participant UserAuthRepository
participant UserAuths
participant PasswordEncoder

User -> LoginForm: ログインフォーム送信
activate LoginForm

LoginForm -> SecurityFilter: リクエスト転送
deactivate LoginForm
activate SecurityFilter

SecurityFilter -> AuthenticationManager: 認証実行(username, password)
activate AuthenticationManager

AuthenticationManager -> UserDetailsServiceImpl: ユーザー情報取得(username)
activate UserDetailsServiceImpl

UserDetailsServiceImpl -> UserAuthRepository: ユーザー検索(username)
activate UserAuthRepository

UserAuthRepository -> UserAuths: データベースから取得
activate UserAuths
UserAuths --> UserAuthRepository: ユーザー情報返却
deactivate UserAuths

UserAuthRepository --> UserDetailsServiceImpl: UserAuthオブジェクト返却
deactivate UserAuthRepository

UserDetailsServiceImpl --> AuthenticationManager: UserDetails返却
deactivate UserDetailsServiceImpl

AuthenticationManager -> PasswordEncoder: パスワード照合
activate PasswordEncoder
PasswordEncoder --> AuthenticationManager: 照合結果
deactivate PasswordEncoder

AuthenticationManager --> SecurityFilter: 認証結果返却
deactivate AuthenticationManager

alt 認証成功
    SecurityFilter --> User: リダイレクト（ログイン成功ページ）
else 認証失敗
    SecurityFilter --> User: リダイレクト（ログイン失敗ページ）
end

deactivate SecurityFilter

@enduml